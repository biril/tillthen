<!DOCTYPE html>

<html>
<head>
  <title>tillthen.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>tillthen.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>Tillthen v0.2.1

https://github.com/biril/tillthen
Licensed and freely distributed under the MIT License
Copyright (c) 2013 Alex Lambiris</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/*global exports, define, process */</span>
(<span class="function"><span class="keyword">function</span> <span class="params">(root, createModule)</span> {</span>
    <span class="string">"use strict"</span>;

    <span class="keyword">var</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Detect the current environment (can be CommonJS, AMD or browser). Tillthen will be
 exposed as a module or global depending on that</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        env = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>A global <code>exports</code> object signifies CommonJS-like enviroments that support
 <code>module.exports</code>, e.g. Node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (Object.prototype.toString.call(exports) === <span class="string">"[object Object]"</span>) {
                <span class="keyword">return</span> <span class="string">"CommonJS"</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>A global <code>define</code> method with an <code>amd</code> property signifies the presence of an AMD
 loader (require.js, curl.js)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (Object.prototype.toString.call(define) === <span class="string">"[object Function]"</span> &amp;&amp; define.amd) {
                <span class="keyword">return</span> <span class="string">"AMD"</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>If none of the above, then assume a browser, without AMD</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> <span class="string">"browser"</span>;
        }()),</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Create a next-turn-evaluation function: A function that evaluates given function <code>f</code> on
 given value <code>v</code>, <em>soon</em>, i.e. <em>not</em> in the same turn of the event loop</p>
<p>(Note that support for CommonJS will be specific to node. So if the detected environment
 is in fact &#39;CommonJS&#39;, the presense of node&#39;s <code>process</code> object is assumed and the latter
 is used to get a reference to Node&#39;s <code>nextTick</code> method)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        evaluateOnNextTurn = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">return</span> env === <span class="string">"CommonJS"</span> ? <span class="function"><span class="keyword">function</span> <span class="params">(f, v)</span> {</span>
                    process.nextTick(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> f(v); });
                } :
                <span class="function"><span class="keyword">function</span> <span class="params">(f, v)</span> {</span> root.setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> f(v); }, <span class="number">0</span>); };
        }());</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Expose as a module or global depending on the detected environment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">switch</span> (env) {
    <span class="keyword">case</span> <span class="string">"CommonJS"</span>:
        createModule(evaluateOnNextTurn, exports);
        <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="string">"AMD"</span>:
        define([<span class="string">"exports"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(exports)</span> {</span>
            <span class="keyword">return</span> createModule(evaluateOnNextTurn, exports);
        });
        <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="string">"browser"</span>:
        root.tillthen = createModule(evaluateOnNextTurn, {});</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>When running in a browser (without AMD modules), attach a <code>noConflict</code> onto the
 <code>tillthen</code> global</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        root.tillthen.noConflict = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Save a reference to the previous value of &#39;tillthen&#39;, so that it can be restored
 later on, if &#39;noConflict&#39; is used</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> previousTillthen = root.tillthen;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Run in no-conflict mode, setting the <code>tillthen</code> global to to its previous value.
 Returns <code>tillthen</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                <span class="keyword">var</span> tillthen = root.tillthen;
                root.tillthen = previousTillthen;
                tillthen.noConflict = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> <span class="keyword">return</span> tillthen; };
                <span class="keyword">return</span> tillthen;
            };
        }());
    }
}(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> <span class="params">(evaluateOnNextTurn, tillthen)</span> {</span>
    <span class="string">"use strict"</span>;

    <span class="keyword">var</span>
        isObject = <span class="function"><span class="keyword">function</span> <span class="params">(o)</span> {</span>
            <span class="keyword">return</span> Object.prototype.toString.call(o) === <span class="string">"[object Object]"</span>;
        },

        isFunction = <span class="function"><span class="keyword">function</span> <span class="params">(f)</span> {</span>
            <span class="keyword">return</span> Object.prototype.toString.call(f) === <span class="string">"[object Function]"</span>;
        },

        extend = <span class="function"><span class="keyword">function</span> <span class="params">(target, source)</span> {</span>
            <span class="keyword">for</span> (<span class="keyword">var</span> x <span class="keyword">in</span> source) { <span class="keyword">if</span> (source.hasOwnProperty(x)) { target[x] = source[x]; } }
            <span class="keyword">return</span> target;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Tillthen deferred constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        TillthenDeferred = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>},</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Tillthen promise constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        TillthenPromise = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>},</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Resolve <code>deferred</code>, i.e. transition it to an appropriate state depending on given <code>x</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        resolveDeferred = <span class="function"><span class="keyword">function</span> <span class="params">(deferred, x)</span> {</span>
            <span class="keyword">var</span> xThen = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>If <code>promise</code> and <code>x</code> refer to the same object, reject promise with a TypeError as
 the reason</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (deferred.promise === x) {
                <span class="keyword">return</span> deferred.reject(<span class="keyword">new</span> TypeError(<span class="string">"Cannot resolve a promise with itself"</span>));
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>If <code>x</code> is a promise, adopt its (future) state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (x <span class="keyword">instanceof</span> TillthenPromise) {
                <span class="keyword">return</span> x.then(deferred.fulfill, deferred.reject);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>if <code>x</code> is <em>not</em> a thenable, fulfill promise with <code>x</code>. If attempting to query <code>then</code>
 throws an error, reject promise with that error as the reason</p>
<p>(The procedure of first storing a reference to <code>x.then</code>, then testing that reference,
 and then calling that reference, avoids multiple accesses to the <code>x.then</code> property
 ensuring consistency in the face of an accessor property, whose value could change
 between retrievals)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">try</span> {
                <span class="keyword">if</span> (!(isObject(x) || isFunction(x)) || !isFunction(xThen = x.then)) {
                    <span class="keyword">return</span> deferred.fulfill(x);
                }
            }
            <span class="keyword">catch</span> (error) { deferred.reject(error); }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>If <code>x</code> is a thenable adopt its (future) state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            xThen(<span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
                resolveDeferred(deferred, value);
            }, <span class="function"><span class="keyword">function</span> <span class="params">(reason)</span> {</span>
                deferred.reject(reason);
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Create an evaluator for given <code>onResulted</code> function and <code>deferred</code> object. When invoked
 with a <code>result</code> (value or reason), the evaluator will evaluate <code>onResulted(result)</code>
 and will use the returned value to resolve <code>deferred</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        createEvaluator = <span class="function"><span class="keyword">function</span> <span class="params">(onResulted, deferred)</span> {</span>
            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(result)</span> {</span>
                <span class="keyword">try</span> { resolveDeferred(deferred, onResulted(result)); }
                <span class="keyword">catch</span> (reason) { deferred.reject(reason); }
            };
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Create a deferred object: A pending promise with <code>resolve</code>, <code>fulfil</code> and <code>reject</code> methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        createDeferred = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Promise&#39;s current state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                state = <span class="string">"pending"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Value of fulfillment or reason of rejection. Will be set when fulfillment or
 rejection actually occurs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                result,</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Queues of fulfillment / rejection handlers. Handlers are added whenever the
 promise&#39;s <code>then</code> method is invoked</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                fulfilQueue = [],
                rejectQueue = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>The actual promise. The deferred will derive from this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                promise = <span class="keyword">new</span> TillthenPromise(),</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Queue a handler and a dependant deferred for fulfillment. When (and if) the
 promise is fullfiled, the handler will be evaluated on promise&#39;s value and the
 result will be used to resolve the dependant deferred</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                queueForFulfillment = <span class="function"><span class="keyword">function</span> <span class="params">(onFulfilled, dependantDeferred)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If the promise is already rejected, there&#39;s nothing to be done</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (state === <span class="string">"rejected"</span>) { <span class="keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If given <code>onFulfilled</code> is not a function then use a pass-through function in
 its place</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    isFunction(onFulfilled) || (onFulfilled = <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span> <span class="keyword">return</span> value; });</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Create an evaluator to do the dirty work and either run it &#39;now&#39; if the
 promise is already fulfilled or as soon as (and if) that eventually happens</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> evaluator = createEvaluator(onFulfilled, dependantDeferred);
                    state === <span class="string">"fulfilled"</span> ? evaluateOnNextTurn(evaluator, result) :
                        fulfilQueue.push(evaluator);
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Queue a handler and a dependant deferred for rejection. When (and if) the promise
 is rejected, the handler will be evaluated on promise&#39;s reason and the result
 will be used to resolve the dependant deferred</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                queueForRejection = <span class="function"><span class="keyword">function</span> <span class="params">(onRejected, dependantDeferred)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>If the promise is already fulfilled, there&#39;s nothing to be done</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (state === <span class="string">"fulfilled"</span>) { <span class="keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>If given <code>onRejected</code> is not a function then use a pass-through function in
 its place</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    isFunction(onRejected) || (onRejected = <span class="function"><span class="keyword">function</span> <span class="params">(error)</span> {</span> <span class="keyword">throw</span> error; });</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Create an evaluator to do the dirty work and either run it &#39;now&#39; if the
 promise is already rejected or as soon as (and if) that eventually happens</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> evaluator = createEvaluator(onRejected, dependantDeferred);
                    state === <span class="string">"rejected"</span> ? evaluateOnNextTurn(evaluator, result) :
                        rejectQueue.push(evaluator);
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Fulfil the promise. Will run the queued fulfillment-handlers and resolve
 dependant promises. Note that the <code>fulfil</code> method will be exposed on the
 returned deferred <em>only</em> - not on any returned promise: not by the deferred&#39;s
 underlying promise or those returned by invoking <code>then</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                fulfill = <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Dont fulfil the promise unless it&#39;s currently in a pending state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (state !== <span class="string">"pending"</span>) { <span class="keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Fulfil the promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    state = <span class="string">"fulfilled"</span>;
                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = fulfilQueue.length; i &lt; l; ++i) { fulfilQueue[i](value); }
                    fulfilQueue = [];
                    result = value;
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Reject the promise. Will run the queued rejection-handlers and resolve
 dependant promises. As with the <code>fulfil</code> method, the <code>reject</code> method will be
 exposed on the returned deferred <em>only</em> - not on any returned promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                reject = <span class="function"><span class="keyword">function</span> <span class="params">(reason)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Dont reject the promise unless it&#39;s currently in a pending state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (state !== <span class="string">"pending"</span>) { <span class="keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Reject the promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    state = <span class="string">"rejected"</span>;
                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = rejectQueue.length; i &lt; l; ++i) { rejectQueue[i](reason); }
                    rejectQueue = [];
                    result = reason;
                };</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Attach the <code>then</code> method to the promise:</p>
<p>Access the promise&#39;s current or eventual fulfillment value or rejection reason.
 As soon as (if ever) the promise is fulfilled, the <code>onFulfilled</code> handler will
 be evaluated on the promise&#39;s fulfillment value. Similarly, as soon as (if ever)
 the promise is rejected, the <code>onRejected</code> handler will be evaluated on the
 rejection reason. Returns a new promise which will be eventually resolved
 with the value / reason / promise returned by <code>onFulfilled</code> or <code>onRejected</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            promise.then = <span class="function"><span class="keyword">function</span> <span class="params">(onFulfilled, onRejected)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Create a new deferred, one which is <em>dependant</em> on (and will be resolved
 with) the the value / reason / promise returned by <code>onFulfilled</code> or
 <code>onRejected</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> dependantDeferred = createDeferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Queue <code>onFulfilled</code> and <code>onRejected</code> for evaluation upon the promise&#39;s
 eventual fulfillment or rejection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                queueForFulfillment(onFulfilled, dependantDeferred);
                queueForRejection(onRejected, dependantDeferred);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Return the dependant deferred&#39;s underlying promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> dependantDeferred.promise;
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Derive a deferred from the promise and return it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            TillthenDeferred.prototype = promise;
            <span class="keyword">return</span> extend(<span class="keyword">new</span> TillthenDeferred(), {
                promise: promise,
                fulfill: fulfill,
                reject: reject,
                resolve: <span class="function"><span class="keyword">function</span> <span class="params">(valueOrPromise)</span> {</span> resolveDeferred(<span class="keyword">this</span>, valueOrPromise); }
            });
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Attach the <code>defer</code> / <code>getVersion</code> methods to Tillthen and return it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> extend(tillthen, {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Get a deferred object: A pending promise with <code>resolve</code>, <code>fulfil</code> and <code>reject</code> methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        defer: createDeferred,</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Get current version of Tillthen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getVersion: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">return</span> <span class="string">"0.2.1"</span>; <span class="comment">// Keep in sync with package.json</span>
        }
    });
}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
